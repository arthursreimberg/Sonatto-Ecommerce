@{
    Layout = null;
    var usuarioNivel = ViewBag.UsuariosNiveis as IEnumerable<UsuariosNiveisViewModel>;
}

<head>
    <link rel="stylesheet" href="~/css/GerenciarPerm.css" />
    <link rel="shortcut icon" href="~/imgs/Logos/Monografia.png" />
    <title>Sonatto</title>
</head>
<body>
    @Html.Partial("_Header")
    <div class="conteudo-page">
        <div class="navDasPag">
            <a asp-controller="Home" asp-action="Index">Home ></a>
            <a asp-controller="Usuario" asp-action="Perfil" style="color:black;">Perfil ></a>
        </div>
        <div class = "faixa">
            <p class="faixa-text1">Escolha um usuário para editar as</p>
            <p class="faixa-text2">Permissões</p>
        </div>
        <div class="container">
            <div class="usuarios-cards">
                @if(usuarioNivel != null)
                {
                    @foreach (var usu in usuarioNivel)
                    {
                        <div class="usuario-card cardUsu" data-id="@usu.IdUsuario">
                            
                            <div class="img-area">
                                <img src="~/imgs/Icones/person-gerenciar.svg" alt="person-gerenciar" />
                            </div>
                            <div class="text-area">
                                <p class="usu-nome">@usu.Nome</p>
                                <p class="permissao-text">Permissões:</p>
                                @if(usu.ListaNiveis != null)
                                {
                                    <p>@usu.ListaNiveis</p>
                                }
                                else
                                {
                                    <p>Nenhuma permissão</p>    
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p>nenhum funcionário encontrado</p>
                }
            </div>
            <div class="alterar-card">
                <div class="faixa-card">
                    <p id="usuNome">Clique em um Usuário ao lado</p>
                </div>
                <p style="align-self:flex-start; margin-left:5%; font-size:18px;">Permissões: </p>
                <div class="permissoes">
                    <div class="permissao">

                        <label class="switch">
                            <input type="checkbox" class="switches"id="switch">
                            <span class="slider"></span>
                        </label>

                        <div class="text-permissao">
                            <p class="nivel-title">Nível 1</p>
                            <p class="text-nivel">Este nível permite que o funcionário <span class="corDestaque">Adicione</span> novos produtos ao sistema</p>
                        </div>
                    </div>
                    <div class="permissao">

                        <label class="switch">
                            <input type="checkbox" class="nivel-switch" data-level="2">
                            <span class="slider"></span>
                        </label>

                        <div class="text-permissao">
                            <p class="nivel-title">Nível 2</p>
                            <p class="text-nivel">Este nível perimte que o funcionário <span class="corDestaque">Edite</span> produtos já existentes do sistema</p>
                        </div>                      
                    </div>
                    <div class="permissao">

                        <label class="switch">
                            <input type="checkbox" class="nivel-switch" data-level="3">
                            <span class="slider"></span>
                        </label>

                        <div class="text-permissao">
                            <p class ="nivel-title">Nível 3</p>
                            <p class="text-nivel">Este nível perimte que o funcionário <span class="corDestaque">Delete</span> produtos já existetes do sistema</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        @Html.Partial("_FooterSlim")

        @* decoracao *@
    <script>
        const spans = document.querySelectorAll(".corDestaque");

        spans.forEach(span => {
            const texto = span.textContent;

            if (texto.includes("Adicione")) {
                span.style.color = "#81AE7E";
            }
            else if (texto.includes("Edite")) {
                span.style.color = "#4720A3";
            }
            else if (texto.includes("Delete")) {
                span.style.color = "#FF3333";
            }
        });
    </script>

   <script>
        const cardsUsu = document.querySelectorAll('.cardUsu');
        const nomeUsu = document.getElementById("usuNome");
        // seleciona inputs que podem ter classes diferentes
        const switchInputs = Array.from(document.querySelectorAll('.switches, .nivel-switch'));

        // lista de usuários recebida do backend
        let usuarios = @Html.Raw(usuarioNivel != null ? System.Text.Json.JsonSerializer.Serialize(usuarioNivel) : "[]");

        function normalizeLevels(raw) {
            if (!raw) return [];
            if (Array.isArray(raw)) return raw.map(x => String(x));
            if (typeof raw === 'number') return [String(raw)];
            if (typeof raw === 'string') {
                const matches = raw.match(/\d+/g);
                if (matches) return matches.map(m => String(m));
                return raw.split(/[\s,;]+/).map(s => s.replace(/\D/g, '')).filter(Boolean);
            }
            return [];
        }

        const inputMap = {};
        switchInputs.forEach((inp, idx) => {
            const lvl = inp.dataset.level ?? inp.dataset.nivel ?? String(idx + 1);
            inputMap[String(lvl)] = inp;
        });

        cardsUsu.forEach(card => {
            card.addEventListener('click', () => {
                const id = card.dataset.id;
                const usuario = usuarios.find(u => String(u.IdUsuario) === id || String(u.Id) === id);

                if (usuario) {
                    nomeUsu.textContent = usuario.Nome;
                    console.log('Usuário selecionado:', usuario.Nome);

                    switchInputs.forEach(sw => sw.checked = false);

                    const rawNiveis = usuario.ListaNiveis ?? usuario.Niveis ?? usuario.NiveisUsuarios ?? usuario.NiveisString;
                    const niveis = normalizeLevels(rawNiveis);

                    niveis.forEach(nivel => {
                        const checkbox = inputMap[String(nivel)];
                        if (checkbox) checkbox.checked = true;
                    });

                    console.log('Níveis aplicados:', niveis);
                } else {
                    switchInputs.forEach(sw => sw.checked = false);
                    nomeUsu.textContent = 'Usuário não encontrado';
                }

                console.log('click');
            });
        });
    </script>

</body>
